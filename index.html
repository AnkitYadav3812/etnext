<script>
const categories = [
  { name: "üåè World", url: "https://news.google.com/rss?hl=en-IN&gl=IN&ceid=IN:en" },
  { name: "üíº Business", url: "https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=en-IN&gl=IN&ceid=IN:en" },
  { name: "‚öôÔ∏è Technology", url: "https://news.google.com/rss/headlines/section/topic/TECHNOLOGY?hl=en-IN&gl=IN&ceid=IN:en" },
  { name: "üèè Sports", url: "https://news.google.com/rss/headlines/section/topic/SPORTS?hl=en-IN&gl=IN&ceid=IN:en" },
  { name: "üé¨ Entertainment", url: "https://news.google.com/rss/headlines/section/topic/ENTERTAINMENT?hl=en-IN&gl=IN&ceid=IN:en" }
];

const nav = document.getElementById("nav");
const content = document.getElementById("content");

// Create category buttons
categories.forEach((c, i) => {
  const btn = document.createElement("button");
  btn.textContent = c.name;
  btn.onclick = () => loadCategory(i);
  nav.appendChild(btn);
});

loadCategory(0); // Load default

// ‚ö°Ô∏è Cache system using sessionStorage
async function loadCategory(i) {
  nav.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  nav.children[i].classList.add("active");
  content.innerHTML = `<div style='text-align:center;'>ü§ñ Loading ${categories[i].name}...</div>`;

  const cacheKey = `ETNext_${categories[i].name}`;
  const cached = sessionStorage.getItem(cacheKey);
  const cachedTime = sessionStorage.getItem(cacheKey + "_time");
  const now = Date.now();

  if (cached && cachedTime && now - cachedTime < 3600000) { // 1 hour cache
    const data = JSON.parse(cached);
    return displayNews(data, categories[i].name);
  }

  const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(categories[i].url)}`;
  try {
    const response = await fetch(api);
    const data = await response.json();
    const items = data.items.slice(0, 10);
    sessionStorage.setItem(cacheKey, JSON.stringify(items));
    sessionStorage.setItem(cacheKey + "_time", now);
    displayNews(items, categories[i].name);
  } catch (e) {
    content.innerHTML = "‚ö†Ô∏è Error loading news.";
  }
}

// üñºÔ∏è Display news with image fixes
function displayNews(articles, title) {
  content.innerHTML = `<h2 style='text-align:center;'>${title}</h2><div class='news-grid'></div>`;
  const grid = content.querySelector(".news-grid");

  articles.forEach(a => {
    let img = "";

    if (a.enclosure?.link) img = a.enclosure.link;
    else if (a.media?.content?.url) img = a.media.content.url;
    else if (a.thumbnail) img = a.thumbnail;
    else if (a.description?.includes("<img")) {
      const match = a.description.match(/<img[^>]+src=["']([^"'>]+)["']/);
      if (match) img = match[1];
    }
    if (!img && a.link.includes("youtube.com")) {
      const id = a.link.match(/v=([^&]+)/)?.[1];
      if (id) img = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
    }
    if (!img && a.link.includes("news.google.com")) {
      const id = btoa(a.link).slice(0, 40);
      img = `https://encrypted-tbn0.gstatic.com/images?q=tbn:${id}`;
    }
    if (!img) img = "https://via.placeholder.com/400x200?text=ETNext+News";

    const card = document.createElement("div");
    card.className = "news-card";
    card.innerHTML = `
      <img src="${img}" alt="News Image" loading="lazy"
           onerror="this.src='https://via.placeholder.com/400x200?text=ETNext+News'">
      <div class="content">
        <h3>${a.title}</h3>
        <p>${a.description?.replace(/<[^>]*>?/gm, '').slice(0,150) || "No description available."}</p>
        <a href="${a.link}" target="_blank" class="read-more">Read More</a>
      </div>`;
    grid.appendChild(card);
  });
}

// üå§Ô∏è Weather System
const weather = document.getElementById("weather-widget");
async function getWeather(city) {
  try {
    const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=6b36b4ff0a7549ce8b412374424110&q=${encodeURIComponent(city)}`);
    const d = await res.json();
    weather.innerHTML = `<h4>${d.location.name}</h4><img src="${d.current.condition.icon}" alt=""><div>${d.current.temp_c}¬∞C | ${d.current.condition.text}</div>`;
  } catch {
    weather.innerHTML = "‚òÅÔ∏è Weather unavailable";
  }
}
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    const geo = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
    const loc = await geo.json();
    const city = loc.city || loc.locality || "Delhi";
    getWeather(city);
  }, () => getWeather("Delhi"));
} else getWeather("Delhi");

// üîç Search and voice input
const searchInput = document.getElementById("search-input");
searchInput.addEventListener("keypress", e => {
  if (e.key === "Enter") performSearch(searchInput.value);
});

async function performSearch(q) {
  if (!q) return;
  const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent("https://news.google.com/rss/search?q="+q+"&hl=en-IN&gl=IN&ceid=IN:en")}`;
  const d = await fetch(api).then(r => r.json());
  displayNews(d.items.slice(0, 10), `üîç Results for "${q}"`);
}

const voiceBtn = document.getElementById("voice-btn");
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  rec.lang = 'en-IN';
  voiceBtn.onclick = () => rec.start();
  rec.onresult = e => {
    const q = e.results[0][0].transcript;
    searchInput.value = q;
    performSearch(q);
  };
}

// üåô Dark mode
document.getElementById("theme-toggle").addEventListener("click", () => {
  document.body.classList.toggle("dark");
  document.getElementById("theme-toggle").textContent =
    document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
});
</script>
